---
title: "Appendix A - ADS506-01-FA22 - Final Project"
author: "Team 1"
date: "12/05/2022"
output:
  html_document:
    df_print: paged
  pdf_document: default
header-includes:
- \usepackage{fvextra}
- \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
always_allow_html: TRUE
---

## RMarkdown global setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.align   = 'center', # how to align graphics in the final doc. 'left', 'right', 'center'
  fig.path    = 'figs/',  # file path to the directory where knitr stores the graphics files
  tidy        = TRUE,
  results     = 'markup',   # knitr will pass through results without reformatting them
  echo        = TRUE,     # in FALSE knitr won't display code in chunk above it's results
  message     = FALSE,     # if FALSE knitr will not display any messages generated by code
  strip.white = TRUE,     # if FALSE knitr won't remove white spaces at beg/end of code chunk
  warning     = FALSE)    # if FALSE knitr will not display any warning messages in the final

```



## Load packages
```{r lib, message=FALSE, warning=FALSE}
library(AppliedPredictiveModeling)
library(car)
library(caret)
library(class)
library(corrplot)
library(e1071)
library(here)
library(Hmisc)
library(imputeTS)
library(lubridate)
library(gridExtra)
library(psych)
library(reshape2)
library(scales)
library(tidyverse)
library(timetk)
#library(tsibble)
library(tseries)
library(zoo)
library(here)

set.seed(1699)
```

## Create custom function to generate boxplots and descriptive statistics for continuous variables
```{r, warning=FALSE}
box_comp <- function(xcol = c(),
                     df = NA,
                     rtn_met = TRUE,
                     grph_title = "All",
                     box = TRUE) {
  # Define function to produce formatted boxplots
  sig <- 3
  metrics_df01 <- data.frame(metric = c("",
                                        "Total N:",
                                        "Count",
                                        "NA Count",
                                        "Mean",
                                        "Median",
                                        "Standard Deviation",
                                        "Variance",
                                        "Range",
                                        "Min",
                                        "Max",
                                        "25th Percentile",
                                        "75th Percentile",
                                        "Subset w/o Outliers:",
                                        "Count",
                                        "%",
                                        "Outlier %",
                                        "NA Count",
                                        "Mean",
                                        "Median",
                                        "Standard Deviation",
                                        "Variance",
                                        "Range",
                                        "Min",
                                        "Max"
                                        ))
  for(var in xcol) {
    df_s1 <- df[, var]
    df_s1s1 <-data.frame(df_s1)
    df_s1_fit <- preProcess(df_s1s1,
                            method = c("center", "scale"))
    df_s1_trans <- predict(df_s1_fit, df_s1s1)

    # Calculate quartiles
    var_iqr_lim <- IQR(df_s1) * 1.5
    var_q1 <- quantile(df_s1, probs = c(.25))
    var_otlow <- var_q1 - var_iqr_lim
    var_q3 <- quantile(df_s1, probs = c(.75))
    var_othigh <- var_q3 + var_iqr_lim
    
    # Subset non-outlier data 
    var_non_otlr_df01 <- subset(df, (abs(df_s1_trans) <= 3))
    #var_non_otlr_df01 <- subset(df, (df_s1 > var_otlow & df_s1 < var_othigh))
    df_s2 <- var_non_otlr_df01[, var]

    # Begin calculating measures of centrality & dispersion
    var_mean <- mean(df_s1, na.remove = TRUE)
    var_non_otlr_df01_trunc_mean <- mean(df_s2, na.remove = TRUE)
    var_med <- median(df_s1)
    var_non_otlr_df01_trunc_med <- median(df_s2)
    var_mode <- mode(df_s1)
    var_non_otlr_df01_trunc_mode <- mode(df_s2)
    var_stde <- sd(df_s1)
    var_non_otlr_df01_trunc_stde <- sd(df_s2)
    var_vari <- var(df_s1)
    var_non_otlr_df01_trunc_vari <- var(df_s2)
    var01_min <- min(df[, var])
    var01_max <- max(df[, var])
    var01_range <- var01_max - var01_min
    var02_min <- min(var_non_otlr_df01[, var])
    var02_max <- max(var_non_otlr_df01[, var])
    var02_range <- var02_max - var02_min
    
    # Configure y-axis min & max to sync graphs
    plot_min <- min(var01_min, var02_min)
    plot_max <- max(var01_max, var02_max)
    nonoutlier_perc <- round((as.numeric(dim(var_non_otlr_df01)[1] / as.numeric(dim(df)[1]))) * 100, 1)
    
    # Fill in metrics table
    measure_val01 <- c(paste0("Variable: ", var),
                       "",
                       as.character(dim(df)[1]),
                       sum(is.na(df_s1)),
                       round(var_mean, sig),
                       round(var_med, sig),
                       round(var_stde, sig),
                       round(var_vari, sig),
                       round(var01_range, sig),
                       round(var01_min, sig),
                       round(var01_max, sig),
                       round(var_q1, sig),
                       round(var_q3, sig),
                       "",
                       as.character(dim(var_non_otlr_df01)[1]),
                       paste0(nonoutlier_perc, "%"),
                       paste0(round(100 - nonoutlier_perc, 1), "%"),
                       sum(is.na(df_s2)),
                       round(var_non_otlr_df01_trunc_mean, sig),
                       round(var_non_otlr_df01_trunc_med, sig),
                       round(var_non_otlr_df01_trunc_stde, sig),
                       round(var_non_otlr_df01_trunc_vari, sig),
                       round(var02_range, sig),
                       round(var02_min, sig),
                       round(var02_max, sig)
                       )
    
    var_name <- paste0("Variable: ", var)
    metrics_df01[, ncol(metrics_df01) + 1] <- measure_val01
}
  # Format boxplot titles based on number of plots
  if(box == TRUE) {
    if(length(xcol == 1)) {
      boxplot(df,
              ylab = "Parameter Values",
              main = paste0("Boxplot for ", xcol, " (", grph_title, ")"))
    }
    else {
      boxplot(df,
              ylab = "Parameter Values",
              main = paste0("Boxplot for Multiple Parameters", " (", grph_title, ")"))
      
    }
  }
  # Return and print metrics table(s)
  if(rtn_met == TRUE) {
    print(metrics_df01)
    return(metrics_df01)
  }
}
```

## Import and merge Datasets
```{r, warning=FALSE}
# "C:/Users/breel.B-E-BELL/OneDrive/Documents/GitHub/506-OceanWater-Team1"

# Import 4 separate CSV files (working directory is main area of GitHub)
curr_dir01 <- here("data/Ocean Water/water_quality_1990_1999_datasd.csv")
#curr_dir01
curr_dir02 <- here("data/Ocean Water/water_quality_2000_2010_datasd.csv")
#curr_dir02
curr_dir03 <- here("data/Ocean Water/water_quality_2011_2019_datasd.csv")
#curr_dir03
curr_dir04 <- here("data/Ocean Water/water_quality_2020_2021_datasd.csv")
#curr_dir04

# Reading in the csv files
owt_df01a <- read.csv(curr_dir01, header = TRUE, sep = ",")
owt_df01b <- read.csv(curr_dir02, header = TRUE, sep = ",")
owt_df01c <- read.csv(curr_dir03, header = TRUE, sep = ",")
owt_df01d <- read.csv(curr_dir04, header = TRUE, sep = ",")


# Merge 4 seperate dataframes into 1
owt_df01 <- rbind(owt_df01a, owt_df01b, owt_df01c, owt_df01d)

# Citation: https://gist.github.com/makexu93/05ef0f34306d3ab6c9ca8ddcd702cee1
owt_df01 <- owt_df01[order(owt_df01$date_sample, decreasing = FALSE), ]
row.names(owt_df01) <- NULL

print(head(owt_df01, 17))
#describe(owt_df01)

```

## Factorize and format column types; print NA counts
```{r}
# List of parameter values
param_lst01 <- c("CHLOROPHYLL",
                 "DENSITY", 
                 "DO", 
                 "ENTERO", 
                 "FECAL", 
                 "OG", 
                 "PH", 
                 "SALINITY", 
                 "SUSO", 
                 "TEMP", 
                 "TOTAL", 
                 "XMS")

# List of col names
col_lst01 <- c("sample",
               "station",
               "date_sample",
               "time",
               "project",
               "parameter",
               "qualifier",
               "units")

# Citation: https://www.geeksforgeeks.org/find-columns-and-rows-with-na-in-r-dataframe/
owt_df02 <- owt_df01
for(c in col_lst01) {
  owt_df02[, c] <- as.factor(owt_df02[, c] )
}

# Generate NA summary tables
# Citation: https://www.geeksforgeeks.org/replace-character-value-with-na-in-r/
owt_df02[owt_df02 == ""] <- NA
print(head(owt_df02, 17))
owt_df02_na <- sapply(owt_df02, function(x) sum(is.na(x)))
owt_df02_notna <- sapply(owt_df02, function(x) sum(!is.na(x)))
owt_df02_tbl01 <- rbind(owt_df02_notna, owt_df02_na)
owt_df02_tbl02 <- rbind(owt_df02_tbl01, round(prop.table(owt_df02_tbl01, margin = 2), 4))
print("All parameters")
print(owt_df02_tbl02)

owt_df02a <- owt_df02[which(is.na(owt_df02), arr.ind=TRUE), ]
#print(head(owt_df02a, 17))

for(p in param_lst01) {
  df = owt_df02[owt_df02$parameter == p, ]
  print(head(df[which(is.na(df$value), arr.ind=TRUE), ], 17))
  df_na <- sapply(df, function(x) sum(is.na(x)))
  df_notna <- sapply(df, function(x) sum(!is.na(x)))
  df_tbl01 <- rbind(df_notna, df_na)
  df_tbl02 <- rbind(df_tbl01, round(prop.table(df_tbl01, margin = 2), 4))
  rownames(df_tbl02) <- c("Not NA n", "NA n", "Not NA %", "NA %")
  print(p)
  print(df_tbl02) # This table w/ null counts and proportions for each feature not displayed for space purposes
}

# Display value summaries
# Citation: Dave Hurst
params <- owt_df02 %>%
  mutate(unit_def = paste(parameter, qualifier, units)) %>%
  count(unit_def)
print(params)
```

## Bin `depth_m` variable
```{r, warning=FALSE}
owt_df02$date_sample <- as.Date(owt_df02$date_sample, "%Y-%m-%d")

# Create bins for depth_m values
depth_lvls01 <- c("[0,8)",
                  "[8,33)",
                  "[33,47)",
                  "[47,70)",
                  "[70,90)",
                  "[90,112)",
                  "[112,120]",
                  "Unknown")

# Plot distribution of depth_m values
# Citation: https://community.rstudio.com/t/ggplot-x-axis-y-axis-ticks-labels-breaks-and-limits/119123/2
ggplot(owt_df02, aes(x = depth_m)) +
  geom_histogram(color = "black", bins = 40, aes(y = stat(density))) +
  geom_density(col = "blue") +
  labs(title = "Histogram of `depth_m` Feature") +
  scale_x_continuous(breaks=seq(0,120,10)) +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

# Create new column with bins
# Citation: https://www.marsja.se/r-add-column-to-dataframe-based-on-other-columns-conditions-dplyr/
owt_df02 <- mutate(owt_df02, depth_m_bin = case_when(depth_m < 8 ~ "[0,8)",
                                                     depth_m < 33 ~ "[8,33)",
                                                     depth_m < 47 ~ "[33,47)",
                                                     depth_m < 70 ~ "[47,70)",
                                                     depth_m < 90 ~ "[70,90)",
                                                     depth_m < 112 ~ "[90,112)",
                                                     depth_m >= 112 ~ "[112,120]"))

# Replace NAs with "Unknown"
# Citation: https://statisticsglobe.com/r-replace-na-with-0/
owt_df02$depth_m_bin <- replace_na(owt_df02$depth_m_bin, "Unknown")

# Citation: https://www.statology.org/order-bars-ggplot2-bar-chart/
owt_df02$depth_m_bin_factr = factor(owt_df02$depth_m_bin, levels = depth_lvls01)
print(head(owt_df02, 17))

# Display transformed bar chart
ggplot(owt_df02, aes(x = depth_m_bin_factr)) +
  geom_bar() +
  labs(title = "Bar of `depth_m_bin` Feature") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```

## Perform several aggregations on the data for performing EDA at multiple levels
```{r}
# Display aggregations by different features
owt_df02_gb01 <- owt_df02 %>%
  group_by(station) %>%
  summarise(Count = n())

print(owt_df02_gb01[owt_df02_gb01$Count == min(owt_df02_gb01$Count), ])
print(owt_df02_gb01[owt_df02_gb01$Count == max(owt_df02_gb01$Count), ])

owt_df02_gb02 <- owt_df02 %>%
  group_by(project) %>%
  summarise(Count = n())

owt_df02_gb03 <- owt_df02 %>%
  group_by(date_sample) %>%
  summarise(Count = n())

# Main DF1
owt_df02_gb04 <- owt_df02 %>%
  group_by(date_sample, parameter) %>%
  summarise(Avg = mean(value, na.remove = TRUE))

owt_df02_gb05 <- owt_df02 %>%
  group_by(parameter) %>%
  summarise(Count = n())

owt_df02_gb06 <- owt_df02 %>%
  group_by(depth_m) %>%
  summarise(Count = n())

# Main DF3
owt_df02_gb07 <- owt_df02 %>%
  group_by(date_sample, project, depth_m_bin, parameter) %>%
  summarise(Avg = mean(value, na.remove = TRUE))

owt_df02_gb08 <- owt_df02 %>%
  group_by(depth_m_bin) %>%
  summarise(Count = n())

# Main DF2
owt_df02_gb09 <- owt_df02 %>%
  group_by(date_sample, project, parameter) %>%
  summarise(Avg = mean(value, na.remove = TRUE))

print(owt_df02_gb01)
print(dim(owt_df02_gb01))
print(owt_df02_gb02)
print(dim(owt_df02_gb02))
print(head(owt_df02_gb03, 17))
print(dim(owt_df02_gb03))
print(head(owt_df02_gb04, 17))
print(dim(owt_df02_gb04))
print(owt_df02_gb05)
print(dim(owt_df02_gb05))
print(owt_df02_gb06)
print(dim(owt_df02_gb06))
print(head(owt_df02_gb07, 17))
print(dim(owt_df02_gb07))
print(owt_df02_gb08)
print(dim(owt_df02_gb08))
print(head(owt_df02_gb09, 17))
print(dim(owt_df02_gb09))
```

## Create custom function to perform df mutation/casting and boxplot display
```{r, warning=FALSE}
ts_eda <- function(ts_df = NA,
                   form_lead = c(),
                   form_cast = c(),
                   param_lst = c(),
                   l1_col = c(),
                   l1_param = c(),
                   l2_col = c(),
                   l2_param = c(),
                   rtn_met = TRUE,
                   grph_title = "All",
                   box = TRUE,
                   week_agg = FALSE,
                   out_rm = FALSE) {
  # Define function to dcast, print boxplot, and print desc stats for each parameter
  dcast_form <- as.formula(paste(paste(form_lead, collapse = "+"), form_cast, sep = "~"))
  print(dcast_form)
  #print(head(ts_df))
  
  counter <- 1
  # Loop to dcast parameters to cols
  for(p in param_lst) {
    sym_param <- sym(p)
    print(sym_param)
    param_df <- ts_df[ts_df[, form_cast] == p, ]
    param_df <- param_df %>%
      drop_na()
    #print(param_df)

    #___________________________________________________________________________
    # If keyword set to TRUE, convert daily TS data to weekly
    if(week_agg == TRUE) {
      param_df02a <- param_df
      param_df02a$week <- isoweek(param_df02a$date_sample)
      # Citation: https://lubridate.tidyverse.org/reference/round_date.html
      param_df02a$week_end <- ceiling_date(param_df02a$date_sample,
                                           unit = "week",
                                           week_start = getOption("lubridate.week.start", 1))
      #print(head(param_df02a, 17)
      param_df$date_sample <- param_df02a$week_end
    }
        
    # Citation: https://www.datasciencemadesimple.com/melting-casting-r/
    param_df_cast <- dcast(param_df, dcast_form, mean)
    #print(head(param_df_cast, 17))

    #___________________________________________________________________________
    # If keyword set to TRUE, remove outliers
    if(out_rm == TRUE) {
      #ts_df_mrgd01c <- na.omit(param_df_cast)
      #print(head(ts_df_mrgd01c, 17))
      #print(dim(ts_df_mrgd01c))
      ts_df_mrgd01c_s1 <- subset(x = param_df_cast, select = p)
      ts_df_mrgd01c_s1_fit <- preProcess(ts_df_mrgd01c_s1,
                                         method = c("center", "scale"))
      ts_df_mrgd01c_s1_trans <- predict(ts_df_mrgd01c_s1_fit,
                                        ts_df_mrgd01c_s1)
  
      # Subset non-outlier data 
      print(dim(param_df_cast))
      param_df_cast <- subset(param_df_cast,
                                  (abs(ts_df_mrgd01c_s1_trans) <= 3))
      dfs1b <- param_df_cast[, p]
      #print(head(param_df_cast, 17))
    }
    
    # For first item in vector, no merge is needed
    if(counter  == 1) {
      ts_df_mrgd <- param_df_cast
    }
    # For 2-n items in vector, merge dataframes iteratively
    else {
      # Merge individual casted parameter df's into 1 df
      # Citation: https://www.geeksforgeeks.org/joining-of-dataframes-in-r-programming/
      ts_df_mrgd <- merge(x = ts_df_mrgd,
                          y = param_df_cast,
                          by = form_lead,
                          all = TRUE)
    }
    
    # Run custom function to ID outliers and generate boxplot
    #ts_df_mrgd01a <- subset(x = ts_df_mrgd, select = num_var_lst01)
    ts_df_mrgd01a <- na.omit(param_df_cast)
    #print(head(ts_df_mrgd01a, 17))
    print(dim(ts_df_mrgd01a))
    dfs1 <- subset(x = ts_df_mrgd01a, select = p)
    dfs1a <- dfs1
    #print(head(dfs1a, 17))
    
    dfs1a$Groups <- as.factor(grph_title)
    box_comp(xcol = p,
             df = dfs1,
             rtn_met = rtn_met,
             box = box)
    #dfs_lst <- list(dfs1)
    #print(dfs_lst)

    #___________________________________________________________________________
    # Create subplots based on additional agg layers
    print(paste0("L2 length = ", length(l2_param)))
    if(length(l2_param) == 0) {
      for(l1 in l1_param) {
        ts_df_mrgd_chl_dmb1 <- ts_df_mrgd01a[(ts_df_mrgd01a[, l1_col] == l1), ]

        # Run custom function to ID outliers and generate boxplot
        #print(head(ts_df_mrgd_chl_dmb1))
        # Citation: https://www.geeksforgeeks.org/handling-errors-in-r-programming/
        dfs2 <- subset(x = ts_df_mrgd_chl_dmb1, select = p)
        dfs2a <- dfs2
        
        
        
        try(dfs2a$Groups <- as.factor(l1))
        try(box_comp(xcol = p,
                     df = dfs2,
                     rtn_met = rtn_met,
                     grph_title = l1,
                     box = box),
            silent = TRUE)
        dfs1a <- rbind(dfs1a, dfs2a)
      }
    }
    else {
      for(l1 in l1_param) {
        for(l2 in l2_param) {
          ts_df_mrgd_chl_dmb1 <- ts_df_mrgd01a[(ts_df_mrgd01a[, l1_col] == l1) & (ts_df_mrgd01a[, l2_col] == l2), ]
  
          # Run custom function to ID outliers and generate boxplot
          #print(head(ts_df_mrgd_chl_dmb1))
          # Citation: https://www.geeksforgeeks.org/handling-errors-in-r-programming/
          dfs3 <- subset(x = ts_df_mrgd_chl_dmb1, select = p)
          dfs3a <- dfs3
          
          
          
          try(dfs3a$Groups <- as.factor(paste0(l1, ": ", l2)))
          try(box_comp(xcol = p,
                       df = dfs3,
                       rtn_met = rtn_met,
                       grph_title = paste0(l1, ": ", l2),
                       box = box),
              silent = TRUE)
          dfs1a <- rbind(dfs1a, dfs3a)
        }
      }
    }
    #_________________________________________________________________________
    #print(dim(dfs1a))
    #print(head(dfs1a, 17))
    bx_form <- as.formula(paste(p, "Groups", sep = "~"))
    #print(bx_form)
    #dfs1a$box_factr = factor(owt_df02$depth_m_bin, levels = depth_lvls01)
    #print(head(dfs1a, 17))
    boxplot(bx_form,
            dfs1a,
            main = "Boxplot(s)")

    counter <- counter + 1
  }
  print(head(ts_df_mrgd, 17))
  print(describe(ts_df_mrgd))
  
  # Display summary of NA count
  ts_df_na <- sapply(ts_df, function(x) sum(is.na(x)))
  ts_df_notna <- sapply(ts_df, function(x) sum(!is.na(x)))
  ts_df_tbl01 <- rbind(ts_df_notna, ts_df_na)
  ts_df_tbl02 <- rbind(ts_df_tbl01, round(prop.table(ts_df_tbl01, margin = 2), 4))
  rownames(ts_df_tbl02) <- c("Not NA n", "NA n", "Not NA %", "NA %")
  print(ts_df_tbl02) # This table w/ null counts and proportions for each feature not displayed for space purposes
  return(ts_df_mrgd)
}
```

## Run custom function on data aggregated by `date_sample` and `parameter`
```{r, fig.height=10, fig.width=30, warning=FALSE}
param_lst02 <- c("CHLOROPHYLL",
                 "DENSITY", 
                 "DO", 
                 "ENTERO", 
                 "FECAL", 
                 "OG", 
                 "PH", 
                 "SALINITY", 
                 "SUSO", 
                 "TEMP", 
                 "XMS")

owt_df02_gb04_mrgd = ts_eda(ts_df = owt_df02_gb04,
                            form_lead = "date_sample",
                            form_cast = "parameter",
                            param_lst = param_lst02,
                            rtn_met = TRUE,
                            box = FALSE,
                            week_agg = FALSE
                            )
```

```{r, fig.height=10, fig.width=30, warning=FALSE}
owt_df02_gb04_wkly = ts_eda(ts_df = owt_df02_gb04,
                            form_lead = "date_sample",
                            form_cast = "parameter",
                            param_lst = param_lst02,
                            rtn_met = TRUE,
                            box = FALSE,
                            week_agg = TRUE
                            )
```

```{r, fig.height=10, fig.width=30, warning=FALSE}
owt_df02_gb04_wkly02 = ts_eda(ts_df = owt_df02_gb04,
                              form_lead = "date_sample",
                              form_cast = "parameter",
                              param_lst = param_lst02,
                              rtn_met = TRUE,
                              box = FALSE,
                              week_agg = TRUE,
                              out_rm = TRUE
                              )
```

## Run custom function on data aggregated by `date_sample`, `project` and `parameter`
```{r, fig.height=10, fig.width=30, warning=FALSE}
owt_df02_gb09_mrgd = ts_eda(ts_df = owt_df02_gb09,
                            form_lead = c("date_sample", "project"),
                            form_cast = "parameter",
                            param_lst = param_lst02,
                            l1_col = c("project"),
                            l1_param = c("PLOO", "SBOO"),
                            rtn_met = FALSE,
                            box = FALSE,
                            week_agg = FALSE
                            )
```

```{r, fig.height=10, fig.width=30, warning=FALSE}
owt_df02_gb09_wkly = ts_eda(ts_df = owt_df02_gb09,
                            form_lead = c("date_sample", "project"),
                            form_cast = "parameter",
                            param_lst = param_lst02,
                            l1_col = c("project"),
                            l1_param = c("PLOO", "SBOO"),
                            rtn_met = FALSE,
                            box = FALSE,
                            week_agg = TRUE
                            )
```

```{r, fig.height=10, fig.width=30, warning=FALSE}
owt_df02_gb09_wkly02 = ts_eda(ts_df = owt_df02_gb09,
                              form_lead = c("date_sample", "project"),
                              form_cast = "parameter",
                              param_lst = param_lst02,
                              l1_col = c("project"),
                              l1_param = c("PLOO", "SBOO"),
                              rtn_met = FALSE,
                              box = FALSE,
                              week_agg = TRUE,
                              out_rm = TRUE
                              )
```

```{r}
owt_df02_gb09_wkly03 <- owt_df02_gb09_wkly
print(head(owt_df02_gb09_wkly03, 17))
```

## Displaying (Visually in Histograms) the Data per Project (Overarching Location)
```{r, warning=FALSE}
# , fig.height=10, fig.width=20, 
# owt_df02_gb09_wkly03
# plotting histograms per project (no depth)

# chlorophyll
hist_chloro <- ggplot(owt_df02_gb09_wkly03, aes(x= CHLOROPHYLL)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "CHLOROPHYLL") +
  theme_classic()

# density
hist_density <- ggplot(owt_df02_gb09_wkly03, aes(x= DENSITY)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "DENSITY")+
  theme_classic()

# DO
hist_do <- ggplot(owt_df02_gb09_wkly03, aes(x= DO)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "DO")+
  theme_classic()

# ENTERO
hist_entero <- ggplot(owt_df02_gb09_wkly03, aes(x= ENTERO)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "ENTERO")+
  theme_classic()

# FECAL
hist_fecal <- ggplot(owt_df02_gb09_wkly03, aes(x= FECAL)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "FECAL")+
  theme_classic()

# OG
hist_og <- ggplot(owt_df02_gb09_wkly03, aes(x= OG)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "OG")+
  theme_classic()

# PH
hist_ph <- ggplot(owt_df02_gb09_wkly03, aes(x= PH)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "pH")+
  theme_classic()

# SALINITY
hist_salinity <- ggplot(owt_df02_gb09_wkly03, aes(x= SALINITY)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "SALINITY")+
  theme_classic()

# SUSO
hist_suso <- ggplot(owt_df02_gb09_wkly03, aes(x= SUSO)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "SUSO")+
  theme_classic()

# TEMP
hist_temp <- ggplot(owt_df02_gb09_wkly03, aes(x= TEMP)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "TEMP (C)")+
  theme_classic()

# XMS
hist_xms <- ggplot(owt_df02_gb09_wkly03, aes(x= XMS)) +
  geom_histogram(aes(color= project, fill= project),
                 position= "identity", bins=7, alpha=.4) +
  labs(title= "XMS")+
theme_classic()

# plotting groups:

# bacteriological basis (chlorophyll, entero, fecal, suso (dissolved solids))
grid.arrange(hist_chloro, hist_entero, hist_fecal,hist_suso, 
             ncol=2, nrow=2) +
  theme(legend.key.size = unit(0.5, "cm"), 
        legend.title = element_text(size=10), 
        legend.text = element_text(size=8), 
        text = element_text(size=10))
```

```{r, warning=FALSE}
# plotting chemical types (pH, salinity, temp)
grid.arrange(hist_ph, hist_salinity, hist_temp,
             ncol=2, nrow=2) +
  theme(legend.key.size = unit(0.5, "cm"), 
        legend.title = element_text(size=10), 
        legend.text = element_text(size=8), 
        text = element_text(size=10))
```


```{r, warning=FALSE}
# plotting optical-chemical type (density, DO, OG, xms)
grid.arrange(hist_density, hist_do, hist_og, hist_xms,
             ncol=2, nrow=2) +
  theme(legend.key.size = unit(0.5, "cm"), 
        legend.title = element_text(size=10), 
        legend.text = element_text(size=8), 
        text = element_text(size=10))
```

## Setting up for Descriptive Statistics and Looking at Non-Time Series Correlations
```{r}
# descriptive stats (no depth) for numeric columns for whole time frame
owt_df02_gb09_wkly03_nums <- subset(owt_df02_gb09_wkly03, select= -c(date_sample))
summary(owt_df02_gb09_wkly03_nums)
```

### If we remove the NA's of the owt_df02_gb09_wkly03 full time frame
```{r}
chlornum <- data.frame("CHLOROPHYLL" = owt_df02_gb09_wkly03_nums$CHLOROPHYLL)
chlornum <- chlornum %>% drop_na()
summary(chlornum)

densnum <- data.frame("DENSITY" = owt_df02_gb09_wkly03_nums$DENSITY)
densnum <- densnum %>% drop_na()
summary(densnum)

donum <- data.frame("DO" = owt_df02_gb09_wkly03_nums$DO)
donum <- donum %>% drop_na()
summary(donum)

enteronum <- data.frame("ENTERO" = owt_df02_gb09_wkly03_nums$ENTERO)
enteronum <- enteronum %>% drop_na()
summary(enteronum)

fecalnum <- data.frame("FECAL" = owt_df02_gb09_wkly03_nums$FECAL)
fecalnum <- fecalnum %>% drop_na()
summary(fecalnum)

ognum <- data.frame("OG" = owt_df02_gb09_wkly03_nums$OG)
ognum <- ognum %>% drop_na()
summary(ognum)

phnum <- data.frame("PH" = owt_df02_gb09_wkly03_nums$PH)
phnum <- phnum %>% drop_na()
summary(phnum)

salinnum <- data.frame("SALINITY" = owt_df02_gb09_wkly03_nums$SALINITY)
salinnum <- salinnum %>% drop_na()
summary(salinnum)

susunum <- data.frame("SUSO" = owt_df02_gb09_wkly03_nums$SUSO)
susunum <- susunum %>% drop_na()
summary(susunum)

tempnum <- data.frame("TEMP" = owt_df02_gb09_wkly03_nums$TEMP)
tempnum <- tempnum %>% drop_na()
summary(tempnum)

xmsnum <- data.frame("XMS" = owt_df02_gb09_wkly03_nums$XMS)
xmsnum <- xmsnum %>% drop_na()
summary(xmsnum)
```

### Looking at each column if we remove NA's (for 1/1/2000 onward)
```{r}
# descriptive stats (no depth) for numeric columns for arbitrary after 1/1/2000
owt_df02_gb09_wkly03_nums_2000s <- owt_df02_gb09_wkly03 %>% filter(date_sample >= "2000-01-01")
owt_df02_gb09_wkly03_nums_2000s <- subset(owt_df02_gb09_wkly03_nums_2000s, select= -c(date_sample))
summary(owt_df02_gb09_wkly03_nums_2000s)
```

### Dropping NA's
```{r}
chlornum2000s <- data.frame("CHLOROPHYLL" = owt_df02_gb09_wkly03_nums_2000s$CHLOROPHYLL)
chlornum2000s <- chlornum2000s %>% drop_na()
summary(chlornum2000s)

densnum2000s <- data.frame("DENSITY" = owt_df02_gb09_wkly03_nums_2000s$DENSITY)
densnum2000s <- densnum2000s %>% drop_na()
summary(densnum2000s)

donum2000s <- data.frame("DO" = owt_df02_gb09_wkly03_nums_2000s$DO)
donum2000s <- donum2000s %>% drop_na()
summary(donum2000s)

enteronum2000s <- data.frame("ENTERO" = owt_df02_gb09_wkly03_nums_2000s$ENTERO)
enteronum2000s <- enteronum2000s %>% drop_na()
summary(enteronum2000s)

fecalnum2000s <- data.frame("FECAL" = owt_df02_gb09_wkly03_nums_2000s$FECAL)
fecalnum2000s <- fecalnum2000s %>% drop_na()
summary(fecalnum2000s)

ognum2000s <- data.frame("OG" = owt_df02_gb09_wkly03_nums_2000s$OG)
ognum2000s <- ognum2000s %>% drop_na()
summary(ognum2000s)

phnum2000s <- data.frame("PH" = owt_df02_gb09_wkly03_nums_2000s$PH)
phnum2000s <- phnum2000s %>% drop_na()
summary(phnum2000s)

salinnum2000s <- data.frame("SALINITY" = owt_df02_gb09_wkly03_nums_2000s$SALINITY)
salinnum2000s <- salinnum2000s %>% drop_na()
summary(salinnum2000s)

susunum2000s <- data.frame("SUSO" = owt_df02_gb09_wkly03_nums_2000s$SUSO)
susunum2000s <- susunum2000s %>% drop_na()
summary(susunum2000s)

tempnum2000s <- data.frame("TEMP" = owt_df02_gb09_wkly03_nums_2000s$TEMP)
tempnum2000s <- tempnum2000s %>% drop_na()
summary(tempnum2000s)

xmsnum2000s <- data.frame("XMS" = owt_df02_gb09_wkly03_nums_2000s$XMS)
xmsnum2000s <- xmsnum2000s %>% drop_na()
summary(xmsnum2000s)
```

## looking at non time series correlations out of curiousity
```{r}
print(paste("chlorophyll", nrow(chlornum), ", density", nrow(densnum), ", DO", nrow(donum), 
           ", entero", nrow(enteronum), ", fecal", nrow(fecalnum), ", OG", nrow(ognum), 
           ", pH", nrow(phnum), ", salinity", nrow(salinnum), ", Suso", nrow(susunum), 
           ", Temp", nrow(tempnum), ", XMS", nrow(xmsnum)))

```

```{r, fig.height=5, fig.width=5, warning=FALSE}
 # least populated in OG at 351 and SUSO at 369.
    # focusing on others, the limit will be Chlorophyll at 1967

densnum_sub <- densnum[1:1967,]
donum_sub <- donum[1:1967,]
enteronum_sub <- enteronum[1:1967,]
fecalnum_sub <- fecalnum[1:1967,]
phnum_sub <- phnum[1:1967,]
salinnum_sub <- salinnum[1:1967,]
tempnum_sub <- tempnum[1:1967,]
xmsnum_sub <- xmsnum[1:1967,]

splitnum_sub <- data.frame("density" = densnum_sub, "DO" =donum_sub, 
                           "enter" =enteronum_sub, "fecal" = fecalnum_sub, 
                           "pH" = phnum_sub, "salinity" = salinnum_sub, 
                           "temp" = tempnum_sub, "xms" = xmsnum_sub)

corrplot(
  cor(splitnum_sub), 
  method = "square",
  type= "lower")
```

```{r}
round(cor(splitnum_sub), 2)
```

## Run custom function on data aggregated by `date_sample`, `project`, `depth_m_bin` and `parameter`
```{r, warning=FALSE, fig.height=10, fig.width=30}
owt_df02_gb07_mrgd = ts_eda(ts_df = owt_df02_gb07,
                            form_lead = c("date_sample", "project", "depth_m_bin"),
                            form_cast = "parameter",
                            param_lst = param_lst02,
                            l1_col = c("project"),
                            l1_param = c("PLOO", "SBOO"),
                            l2_col = c("depth_m_bin"),
                            l2_param = depth_lvls01,
                            rtn_met = FALSE,
                            box = FALSE
                            )
```

```{r, fig.height=10, fig.width=30, warning=FALSE}
owt_df02_gb07_wkly = ts_eda(ts_df = owt_df02_gb07,
                            form_lead = c("date_sample", "project", "depth_m_bin"),
                            form_cast = "parameter",
                            param_lst = param_lst02,
                            l1_col = c("project"),
                            l1_param = c("PLOO", "SBOO"),
                            l2_col = c("depth_m_bin"),
                            l2_param = depth_lvls01,
                            rtn_met = FALSE,
                            box = FALSE,
                            week_agg = TRUE
                            )
```

```{r, EDA-CC-linearinterpolation, warning=FALSE}

# Define function that imputes the missing values to parameter dataframe using linear interpolation
impute_missing_values <- function(df_data) {
  
    params <- c("CHLOROPHYLL", "DENSITY", "DO", "ENTERO", "FECAL", "OG", "PH", "SALINITY", "SUSO", "TEMP", "XMS")
  
  for (param in params) {
    print(head(df_data, 17))
    print(param)
    print(date_sample)
    
    x <- zoo(df_data$param, df_data$date_sample)
    df_data$param <- na.interpolation(x, option = "linear")
    return(df_data)
  
  }
}

# remove NAs
# Linear Interpolation

# owt_df02_gb04_mrgd
x <- zoo(owt_df02_gb04_mrgd$CHLOROPHYLL, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$CHLOROPHYLL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$DENSITY, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$DENSITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$DO, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$DO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$ENTERO, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$ENTERO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$FECAL, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$FECAL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$OG, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$OG <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$PH, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$PH <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$SALINITY, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$SALINITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$SUSO, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$SUSO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$TEMP, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$TEMP <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_mrgd$XMS, owt_df02_gb04_mrgd$date_sample)
owt_df02_gb04_mrgd$XMS <- na.interpolation(x, option = "linear")


# owt_df02_gb04_wkly
x <- zoo(owt_df02_gb04_wkly$CHLOROPHYLL, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$CHLOROPHYLL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$DENSITY, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$DENSITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$DO, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$DO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$ENTERO, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$ENTERO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$FECAL, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$FECAL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$OG, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$OG <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$PH, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$PH <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$SALINITY, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$SALINITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$SUSO, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$SUSO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$TEMP, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$TEMP <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb04_wkly$XMS, owt_df02_gb04_wkly$date_sample)
owt_df02_gb04_wkly$XMS <- na.interpolation(x, option = "linear")


# owt_df02_gb09_mrgd
x <- zoo(owt_df02_gb09_mrgd$CHLOROPHYLL, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$CHLOROPHYLL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$DENSITY, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$DENSITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$DO, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$DO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$ENTERO, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$ENTERO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$FECAL, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$FECAL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$OG, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$OG <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$PH, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$PH <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$SALINITY, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$SALINITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$SUSO, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$SUSO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$TEMP, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$TEMP <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_mrgd$XMS, owt_df02_gb09_mrgd$date_sample)
owt_df02_gb09_mrgd$XMS <- na.interpolation(x, option = "linear")


# owt_df02_gb09_wkly <- impute_missing_values(owt_df02_gb09_wkly)
x <- zoo(owt_df02_gb09_wkly$CHLOROPHYLL, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$CHLOROPHYLL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$DENSITY, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$DENSITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$DO, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$DO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$ENTERO, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$ENTERO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$FECAL, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$FECAL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$OG, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$OG <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$PH, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$PH <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$SALINITY, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$SALINITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$SUSO, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$SUSO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$TEMP, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$TEMP <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb09_wkly$XMS, owt_df02_gb09_wkly$date_sample)
owt_df02_gb09_wkly$XMS <- na.interpolation(x, option = "linear")


# owt_df02_gb07_mrgd
x <- zoo(owt_df02_gb07_mrgd$CHLOROPHYLL, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$CHLOROPHYLL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$DENSITY, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$DENSITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$DO, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$DO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$ENTERO, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$ENTERO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$FECAL, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$FECAL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$OG, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$OG <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$PH, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$PH <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$SALINITY, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$SALINITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$SUSO, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$SUSO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$TEMP, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$TEMP <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_mrgd$XMS, owt_df02_gb07_mrgd$date_sample)
owt_df02_gb07_mrgd$XMS <- na.interpolation(x, option = "linear")


# owt_df02_gb07_mrgd
x <- zoo(owt_df02_gb07_wkly$CHLOROPHYLL, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$CHLOROPHYLL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$DENSITY, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$DENSITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$DO, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$DO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$ENTERO, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$ENTERO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$FECAL, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$FECAL <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$OG, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$OG <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$PH, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$PH <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$SALINITY, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$SALINITY <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$SUSO, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$SUSO <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$TEMP, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$TEMP <- na.interpolation(x, option = "linear")

x <- zoo(owt_df02_gb07_wkly$XMS, owt_df02_gb07_wkly$date_sample)
owt_df02_gb07_wkly$XMS <- na.interpolation(x, option = "linear")


```

```{r CC-EDA-PAD-MISSINGDATES}

# https://cran.r-project.org/web/packages/padr/vignettes/padr.html
library(padr)
library(dplyr)

owt_df02_gb04_mrgd %>% pad()

####### 5 YEAR - 1996 - 2001 #######################################
ts_chlorophyll <- ts(owt_df02_gb04_mrgd$CHLOROPHYLL, start = c(1996, 1), freq = 365)
ts_1996_2001_chl <- window(ts_chlorophyll, start=c(1999, 1))
stl_chl <- stl(ts_1996_2001_chl, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_chl)
mtext("CHLOROPHYLL", side=3, line = -5)


ts_do <- ts(owt_df02_gb04_mrgd$DO, start = c(1996, 1), freq = 365)
ts_1996_2001_do <- window(ts_do, start=c(1999, 1))
stl_do <- stl(ts_1996_2001_do, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_do)
mtext("DO", side=3, line = -5)


ts_ent <- ts(owt_df02_gb04_mrgd$ENTERO, start = c(1996, 1), freq = 365)
ts_1996_2001_ent <- window(ts_ent, start=c(1999, 1))
stl_ent <- stl(ts_1996_2001_ent, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_ent)
mtext("ENTERO", side=3, line = -5)


ts_fecal <- ts(owt_df02_gb04_mrgd$FECAL, start = c(1996, 1), freq = 365)
ts_1996_2001_fecal <- window(ts_fecal, start=c(1999, 1))
stl_fecal <- stl(ts_1996_2001_fecal, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_fecal)
mtext("FECAL", side=3, line = -5)


ts_og <- ts(owt_df02_gb04_mrgd$OG, start = c(1996, 1), freq = 365)
ts_1996_2001_og <- window(ts_og, start=c(1999, 1))
stl_og <- stl(ts_1996_2001_og, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_og)
mtext("OG", side=3, line = -5)


ts_ph <- ts(owt_df02_gb04_mrgd$PH, start = c(1996, 1), freq = 365)
ts_1996_2001_ph <- window(ts_ph, start=c(1999, 1))
stl_ph <- stl(ts_1996_2001_ph, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_ph)
mtext("PH", side=3, line = -5)


ts_salinity <- ts(owt_df02_gb04_mrgd$SALINITY, start = c(1996, 1), freq = 365)
ts_1996_2001_salinity <- window(ts_salinity, start=c(1999, 1))
stl_salinity <- stl(ts_1996_2001_salinity, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_salinity)
mtext("SALINITY", side=3, line = -5)


ts_suso <- ts(owt_df02_gb04_mrgd$SUSO, start = c(1996, 1), freq = 365)
ts_1996_2001_suso <- window(ts_suso, start=c(1999, 1))
stl_suso <- stl(ts_1996_2001_suso, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_suso)
mtext("SUSO", side=3, line = -5)


ts_temp <- ts(owt_df02_gb04_mrgd$TEMP, start = c(1996, 1), freq = 365)
ts_1996_2001_temp <- window(ts_temp, start=c(1999, 1))
stl_temp <- stl(ts_1996_2001_temp, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_temp)
mtext("TEMP", side=3, line = -5)


ts_xms <- ts(owt_df02_gb04_mrgd$XMS, start = c(1996, 1), freq = 365)
ts_1996_2001_xms <- window(ts_xms, start=c(1999, 1))
stl_xms <- stl(ts_1996_2001_xms, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_xms)
mtext("XMS", side=3, line = -5)


```

{r CC-EDA-STL-1YEARPERIOD}

####### 1 YEAR - 2001 #######################################
ts_chlorophyll <- ts(owt_df02_gb04_mrgd$CHLOROPHYLL, start = c(2001, 1), freq = 365)
ts_1996_2001_chl <- window(ts_chlorophyll, start=c(2001, 1), end=c(2001, 2))
plot(ts_1996_2001_chl)
stl_chl <- stl(ts_1996_2001_chl, s.window="periodic")
#labels.chart = seq(as.Date("1990-11-15"), as.Date("2021-12-29"), by = "weeks")
plot(stl_chl)
mtext("CHLOROPHYLL", side=3, line = -5)


```{r CC-PREPROCESING-TRAINSPLIT}

library(forecast)

# All parameters exhibited seasonal cycles within a year range, so
# it would make sense to have several years worth of datapoints for the training period.  This set below can be used for all parameters.
train <- head(owt_df02_gb04_mrgd, round(NROW(owt_df02_gb04_mrgd) * 0.6))
h <- length(owt_df02_gb04_mrgd) - NROW(train)
test <- tail(owt_df02_gb04_mrgd, h)

```

## Define custom function to produce scatterplots comparing multiple predictors to one target
```{r}
param_lst03 <- c("CHLOROPHYLL",
                 "DENSITY", 
                 "DO", 
                 "FECAL", 
                 "OG", 
                 "PH", 
                 "SALINITY", 
                 "SUSO", 
                 "TEMP", 
                 "XMS")

scatr <- function(df = NA,
                  y = NA,
                  x_lst = c()) {
  for (p in x_lst) {
    plot <- ggplot(df, aes(df[, p], df[, y])) +
    geom_point() +
    stat_smooth(method = "lm",
                formula = y ~ x,
                geom = "smooth") +
    labs(x = p,
         y = y,
         title = "Figure",
         subtitle = paste0("Scatterplot of ", p, " and ", y, " Series"))
    print(plot)
  }
}
```

## Run custom function on data aggregated by `date_sample` and `parameter`
```{r}
# All data
scatr(df = owt_df02_gb04_wkly,
      y = "ENTERO",
      x_lst = param_lst03)
```

```{r}
# Excluding outliers
print(head(owt_df02_gb04_wkly02, 17))
scatr(df = owt_df02_gb04_wkly02,
      y = "ENTERO",
      x_lst = param_lst03)
```

## Define custom function to display time series plots at multiple agg levels
```{r}
# i = parameter
# j = project
# k = depth
time_plt <- function(df = NA,
                     date = NA,
                     l1 = c(),
                     l2_name = NA,
                     l2 = c(),
                     l3_name = NA,
                     l3 = c()) {
  if(length(l3) == 0 & length(l2) == 0) {
    for(i in l1) {
      df_01a <- df
      par(mar = c(5,5,5,2))
      try(print(acf(df_01a[, i],
                    pl = TRUE,
                    na.action = na.pass,
                    main = paste0("ACF Plot for ", i))))
      plot <- ggplot(df_01a, aes(x = df_01a[, date], y = df_01a[, i], group = 1)) +
        geom_line() +
        labs(x = "Time",
             y = i,
             title = "Figure",
             subtitle = paste0("Time Series Plot for ", i))
      print(plot)
    }
  }
  if(length(l3) == 0) {
    for(i in l1) {
      for(j in l2) {
          df_01a <- df[df[, l2_name] == j, ]
          par(mar = c(5,5,5,2))
          try(print(acf(df_01a[, i],
                        pl = TRUE,
                        na.action = na.pass,
                        main = paste0("ACF Plot for ", i, " (", j, ")"))))
          plot <- ggplot(df_01a, aes(x = df_01a[, date], y = df_01a[, i], group = 1)) +
            geom_line() +
            labs(x = "Time",
                 y = i,
                 title = "Figure",
                 subtitle = paste0("Time Series Plot for ", i, " (", j, ")"))
          print(plot)
      }
    }
  }
  else {
    for(i in l1) {
      for(j in l2) {
        for(k in l3) {
          df_01a <- df[df[, l2_name] == j & df[, l3_name] == k, ]
          par(mar = c(5,5,5,2))
          try(print(acf(df_01a[, i],
                        pl = TRUE,
                        na.action = na.pass,
                        main = paste0("ACF Plot for ", i, " (", j, ": ", k, ")"))))
          plot <- ggplot(df_01a, aes(x = df_01a[, date], y = df_01a[, i], group = 1)) +
            geom_line() +
            labs(x = "Time",
                 y = i,
                 title = "Figure",
                 subtitle = paste0("Time Series Plot for ", i, " (", j, ": ", k, ")"))
          print(plot)
        }
      }
    }
  }
}
```

## Setup reference value lists for time series plotting
```{r}
param_lst04 <- c("CHLOROPHYLL",
                 "DENSITY", 
                 "DO", 
                 "ENTERO", 
                 "FECAL", 
                 "PH", 
                 "SALINITY", 
                 "TEMP", 
                 "XMS")

param_lst05 <- c("ENTERO")

uniq_proj <- unique(owt_df02_gb07_mrgd$project)
uniq_depth <- unique(owt_df02_gb07_mrgd$depth_m_bin)
uniq_proj
uniq_depth
```

## Run custom function on data aggregated by `date_sample` and `parameter`
```{r, fig.height=15, fig.width=30}
time_plt(df = owt_df02_gb04_mrgd,
         date = "date_sample",
         l1 = param_lst05)
```

## Run custom function on data aggregated by `date_sample`, `project`, `depth_m_bin` and `parameter`
```{r, fig.height=15, fig.width=30}
time_plt(df = owt_df02_gb07_mrgd,
         date = "date_sample",
         l1 = param_lst05,
         l2_name = "project",
         l2 = uniq_proj,
         l3_name = "depth_m_bin",
         l3 = uniq_depth)
```

## Convert df's to `timetk` tibbles for data aggregated by `date_sample`, `project`, and `parameter`
```{r}
# Citation: https://business-science.github.io/timetk/index.html

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Convert PLOO data for 01/18/1999 and 01/03/2022 to `timetk` TS tibble
owt_df02_gb09_ploo_wkly03_df01 <- owt_df02_gb09_wkly03[owt_df02_gb09_wkly03$project == "PLOO" & owt_df02_gb09_wkly03$date_sample >= "1999-1-18", ]
owt_df02_gb09_ploo_wkly03_df02 <- owt_df02_gb09_ploo_wkly03_df01[, -c(2, 8, 11)]
#owt_df02_gb09_ploo_wkly03_df02$date_sample <- yearweek(owt_df02_gb09_ploo_wkly03_df02$date_sample, week_start = getOption("lubridate.week.end", 1))

owt_df02_gb09_ploo_wkly03_tb01 <- tibble(owt_df02_gb09_ploo_wkly03_df02)
owt_df02_gb09_ploo_wkly03_tb02 <- pad_by_time(.data = owt_df02_gb09_ploo_wkly03_tb01,
                                              .date_var = date_sample,
                                              .by = "week")

#-------------------------------------------------------------------------------
# Convert PLOO data (excluding outliers) for 01/18/1999 and 01/03/2022 to `timetk` TS tibble
owt_df02_gb09_ploo_wkly02_df01 <- owt_df02_gb09_wkly02[owt_df02_gb09_wkly02$project == "PLOO" & owt_df02_gb09_wkly02$date_sample >= "1999-1-18", ]
owt_df02_gb09_ploo_wkly02_df02 <- owt_df02_gb09_ploo_wkly02_df01[, -c(2, 8, 11)]

owt_df02_gb09_ploo_wkly02_tb01 <- tibble(owt_df02_gb09_ploo_wkly02_df02)
owt_df02_gb09_ploo_wkly02_tb02 <- pad_by_time(.data = owt_df02_gb09_ploo_wkly02_tb01,
                                              .date_var = date_sample,
                                              .by = "week")

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Convert SBOO data for 01/18/1999 and 01/03/2022 to `timetk` TS tibble
owt_df02_gb09_sboo_wkly03_df01 <- owt_df02_gb09_wkly03[owt_df02_gb09_wkly03$project == "SBOO" & owt_df02_gb09_wkly03$date_sample >= "1999-1-18", ]
owt_df02_gb09_sboo_wkly03_df02 <- owt_df02_gb09_sboo_wkly03_df01[, -c(2, 8, 11)]

owt_df02_gb09_sboo_wkly03_tb01 <- tibble(owt_df02_gb09_sboo_wkly03_df02)
owt_df02_gb09_sboo_wkly03_tb02 <- pad_by_time(.data = owt_df02_gb09_sboo_wkly03_tb01,
                                              .date_var = date_sample,
                                              .by = "week")

#-------------------------------------------------------------------------------
# Convert SBOO data (excluding outliers) for 01/18/1999 and 01/03/2022 to `timetk` TS tibble
owt_df02_gb09_sboo_wkly02_df01 <- owt_df02_gb09_wkly02[owt_df02_gb09_wkly02$project == "SBOO" & owt_df02_gb09_wkly02$date_sample >= "1999-1-18", ]
owt_df02_gb09_sboo_wkly02_df02 <- owt_df02_gb09_sboo_wkly02_df01[, -c(2, 8, 11)]

owt_df02_gb09_sboo_wkly02_tb01 <- tibble(owt_df02_gb09_sboo_wkly02_df02)
owt_df02_gb09_sboo_wkly02_tb02 <- pad_by_time(.data = owt_df02_gb09_sboo_wkly02_tb01,
                                              .date_var = date_sample,
                                              .by = "week")
```

## Partition tibbles for data aggregated by `date_sample`, `project`, and `parameter`
```{r}
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# PLOO All - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_ploo_wkly03_train_tb02 <- owt_df02_gb09_ploo_wkly03_tb02 %>%
  filter_by_time(date_sample,
                 .end_date = "2021-01-04")

# PLOO All - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_ploo_wkly03_test_tb02 <- owt_df02_gb09_ploo_wkly03_tb02 %>%
  filter_by_time(date_sample,
                 .start_date = "2021-01-11")

#-------------------------------------------------------------------------------
# PLOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_ploo_wkly02_train_tb02 <- owt_df02_gb09_ploo_wkly02_tb02 %>%
  filter_by_time(date_sample,
                 .end_date = "2021-01-04")

# PLOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_ploo_wkly02_test_tb02 <- owt_df02_gb09_ploo_wkly02_tb02 %>%
  filter_by_time(date_sample,
                 .start_date = "2021-01-11")

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# SBOO All - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_sboo_wkly03_train_tb02 <- owt_df02_gb09_sboo_wkly03_tb02 %>%
  filter_by_time(date_sample,
                 .end_date = "2021-01-04")

# SBOO All - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_sboo_wkly03_test_tb02 <- owt_df02_gb09_sboo_wkly03_tb02 %>%
  filter_by_time(date_sample,
                 .start_date = "2021-01-11")

#-------------------------------------------------------------------------------
# SBOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_sboo_wkly02_train_tb02 <- owt_df02_gb09_sboo_wkly02_tb02 %>%
  filter_by_time(date_sample,
                 .end_date = "2021-01-04")

# SBOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_sboo_wkly02_test_tb02 <- owt_df02_gb09_sboo_wkly02_tb02 %>%
  filter_by_time(date_sample,
                 .start_date = "2021-01-11")
```

## Display tibbles available for modeling
```{r}
# Data sets for modeling
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# PLOO All - Training partition (01/18/1999-01/04/2021)
print(head(owt_df02_gb09_ploo_wkly03_train_tb02, 10))
print(dim(owt_df02_gb09_ploo_wkly03_train_tb02))

# PLOO All - Test partition (01/11/2021-01/03/2022)
print(head(owt_df02_gb09_ploo_wkly03_test_tb02, 10))
print(dim(owt_df02_gb09_ploo_wkly03_test_tb02))

#-------------------------------------------------------------------------------
# PLOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
print(head(owt_df02_gb09_ploo_wkly02_train_tb02, 10))
print(dim(owt_df02_gb09_ploo_wkly02_train_tb02))

# PLOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
print(head(owt_df02_gb09_ploo_wkly02_test_tb02, 10))
print(dim(owt_df02_gb09_ploo_wkly02_test_tb02))

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# SBOO All - Training partition (01/18/1999-01/04/2021)
print(head(owt_df02_gb09_sboo_wkly03_train_tb02, 10))
print(dim(owt_df02_gb09_sboo_wkly03_train_tb02))

# SBOO All - Test partition (01/11/2021-01/03/2022)
print(head(owt_df02_gb09_sboo_wkly03_test_tb02, 10))
print(dim(owt_df02_gb09_sboo_wkly03_test_tb02))

#-------------------------------------------------------------------------------
# SBOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
print(head(owt_df02_gb09_sboo_wkly02_train_tb02, 1000))
print(dim(owt_df02_gb09_sboo_wkly02_train_tb02))

# SBOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
print(head(owt_df02_gb09_sboo_wkly02_test_tb02, 10))
print(dim(owt_df02_gb09_sboo_wkly02_test_tb02))
```

## STL plotting - *WORK IN PROGRESS*
```{r}
owt_df02_gb09_sboo_wkly02_tb02 %>%
  plot_time_series(date_sample,
                   ENTERO)
```

## Imputation - *WORK IN PROGRESS*
```{r}
# Impute missing values using TS imputation w/ seasonality
qk_imp <- function(df = NA) {
  df$CHLOROPHYLL <- ts_impute_vec(df$CHLOROPHYLL,
                                  period = 3,
                                  lambda = NULL)
  
  df$DENSITY <- ts_impute_vec(df$DENSITY,
                              period = 3,
                              lambda = NULL)
  
  df$DO <- ts_impute_vec(df$DO,
                         period = 3,
                         lambda = NULL)
  
  df$ENTERO <- ts_impute_vec(df$ENTERO,
                             period = 3,
                             lambda = NULL)
  
  df$FECAL <- ts_impute_vec(df$FECAL,
                            period = 3,
                            lambda = NULL)
  
  df$PH <- ts_impute_vec(df$PH,
                         period = 3,
                         lambda = NULL)
  
  df$SALINITY <- ts_impute_vec(df$SALINITY,
                               period = 3,
                               lambda = NULL)
  
  df$TEMP <- ts_impute_vec(df$TEMP,
                           period = 3,
                           lambda = NULL)
  
  df$XMS <- ts_impute_vec(df$XMS,
                          period = 3,
                          lambda = NULL)
  return(df)
}

# PLOO All - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_ploo_wkly03_train_tb03 <- qk_imp(df = owt_df02_gb09_ploo_wkly03_train_tb02)
print(head(owt_df02_gb09_ploo_wkly03_train_tb03, 10))

# PLOO All - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_ploo_wkly03_test_tb03 <- qk_imp(df = owt_df02_gb09_ploo_wkly03_test_tb02)
print(head(owt_df02_gb09_ploo_wkly03_test_tb03, 10))

#-------------------------------------------------------------------------------
# PLOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_ploo_wkly02_train_tb03 <- qk_imp(df = owt_df02_gb09_ploo_wkly02_train_tb02)
print(head(owt_df02_gb09_ploo_wkly02_train_tb03, 10))

# PLOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_ploo_wkly02_test_tb03 <- qk_imp(df = owt_df02_gb09_ploo_wkly02_test_tb02)
print(head(owt_df02_gb09_ploo_wkly02_test_tb03, 10))

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# SBOO All - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_sboo_wkly03_train_tb03 <- qk_imp(df = owt_df02_gb09_sboo_wkly03_train_tb02)
print(head(owt_df02_gb09_sboo_wkly03_train_tb03, 10))

# SBOO All - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_sboo_wkly03_test_tb03 <- qk_imp(df = owt_df02_gb09_sboo_wkly03_test_tb02)
print(head(owt_df02_gb09_sboo_wkly03_test_tb03, 10))

#-------------------------------------------------------------------------------
# SBOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
owt_df02_gb09_sboo_wkly02_train_tb03 <- qk_imp(df = owt_df02_gb09_sboo_wkly02_train_tb02)
print(head(owt_df02_gb09_sboo_wkly02_train_tb03, 10))

# SBOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
owt_df02_gb09_sboo_wkly02_test_tb03 <- qk_imp(df = owt_df02_gb09_sboo_wkly02_test_tb02)
print(head(owt_df02_gb09_sboo_wkly02_test_tb03, 10))

owt_df02_gb09_ploo_wkly03_train_tb03 %>%
  plot_stl_diagnostics(date_sample,
                       ENTERO,
                       .frequency = "auto",
                       .trend = "auto")
```

# Modeling
## Linear Regression Modeling
```{r, fig.height=15, fig.width=30}
# PLOO All - Training partition (01/18/1999-01/04/2021)
print(head(owt_df02_gb09_ploo_wkly03_train_tb02, 10))
# PLOO All - Test partition (01/11/2021-01/03/2022)
print(head(owt_df02_gb09_ploo_wkly03_test_tb02, 10))

print(lubridate:::isoweek(ymd("1999-01-18")))
gb09_ploo_wkly03_train_ts01_ent01 <- ts(owt_df02_gb09_ploo_wkly03_train_tb02$ENTERO,
                                        start = c(1999, 3),
                                        freq = 52)
gb09_ploo_wkly03_train_ts01_ent01
gb09_ploo_wkly03_m1v1_fit <- tslm(gb09_ploo_wkly03_train_ts01_ent01 ~ trend + I(trend^2) + season)
gb09_ploo_wkly03_m1v1_prd <- forecast(gb09_ploo_wkly03_m1v1_fit, h = 52)

plot(owt_df02_gb09_ploo_wkly03_train_tb02[, c(1, 5)],
     type = "l",
     #xlim = c(),
     xlab = "Time",
     ylab = "Parameter Values",
     main = "Figure. Parameter Values Over Time")
lines(owt_df02_gb09_ploo_wkly03_test_tb02[, c(1, 5)], lwd = 2, col = "blue")
lines(gb09_ploo_wkly03_m1v1_prd$fitted, lwd = 2, col = "orange")
grid()

plot(gb09_ploo_wkly03_m1v1_prd,
     type = "l",
     #xlim = c(),
     xlab = "Time",
     ylab = "Parameter Values",
     main = "Figure. Parameter Values Over Time")
#lines(owt_df02_gb09_ploo_wkly03_test_tb02[, c(1, 5)], lwd = 2, col = "blue")
lines(gb09_ploo_wkly03_m1v1_prd$fitted, lwd = 2, col = "orange")
grid()

plot(filter_by_time(owt_df02_gb09_ploo_wkly03_tb02[, c(1, 5)],
                    date_sample,
                    .start_date = "2015",
                    .end_date = "2023"),
     type = "l",
     xlab = "Time",
     ylab = "Parameter Values",
     main = "Figure. Parameter Values Over Time")
lines(filter_by_time(owt_df02_gb09_ploo_wkly03_test_tb02[, c(1, 5)],
                    date_sample,
                    .start_date = "2019",
                    .end_date = "2023"), lwd = 2, col = "blue")
grid()

#ggplot(owt_df02_gb09_ploo_wkly03_tb02, aes(date_sample, ENTERO)) +
#  geom_line() +
#  labs(x = "Time",
#       y = "Weekly Sales",
#       title = "Figure 7.5.",
#       subtitle = "Walmart Store #1, Dept #72 Weekly Sales Over Time")

```

## ARIMA Modeling
```{r}
# PLOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
  # owt_df02_gb09_ploo_wkly02_train_tb03 
gb09_ploo_wkly02_train_ts01_ent01 <- ts(owt_df02_gb09_ploo_wkly02_train_tb03$ENTERO,
                                        start = c(1999, 3),
                                        freq = 52)
# PLOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
  # owt_df02_gb09_ploo_wkly02_test_tb03 

# pacf plot of entero (ploo)
par(mar=c(5, 4, 0, 2)+1.5)
pacf(gb09_ploo_wkly02_train_ts01_ent01)
title("Entero at PLOO pacf plot")

```

### ARIMA of only entero on PLOO data
```{r, warning=FALSE}
  # The plot shows no lines exceeding the boundaries so ar=p=0
  # we aren't doing any differences so d=0
  # From acf PLOO plot previously done, there are 3 or 4 leaving boundary so q= 3 or 4
  # No seasonality (previous PLOO time series graph)

# calling arima function
arima_entero_ploo_q3 <- arima(gb09_ploo_wkly03_train_ts01_ent01, order= c(0, 0, 3))
summary(arima_entero_ploo_q3)
  
# saving training rmse value
arima_entero_ploo_q3_train_rmse <- 102.5163

# making forecasts and saving them
arima_entero_ploo_q3_forecast <- forecast(arima_entero_ploo_q3, h=52)

# getting plot ready
autoplot(gb09_ploo_wkly02_train_ts01_ent01, 
         main = "ARIMA(0,0,3) for only Entero at PLOO", 
         ylab = "Entero (cfu/100mL)") +
  autolayer(arima_entero_ploo_q3_forecast, alpha=.3) +
  coord_cartesian(xlim=c(2015, 2025)) +
  coord_cartesian(ylim=c(0, 1000)) +
  theme_classic()
```

```{r, warning=FALSE}
# calling arima function
arima_entero_ploo_q4 <- arima(gb09_ploo_wkly03_train_ts01_ent01, order= c(0, 0, 4))

summary(arima_entero_ploo_q4)
  
# saving training rmse value
arima_entero_ploo_q4_train_rmse <- 102.4938

# making forecasts and saving them
arima_entero_ploo_q4_forecast <- forecast(arima_entero_ploo_q4, h=52)

# getting plot ready
autoplot(gb09_ploo_wkly02_train_ts01_ent01, 
         main = "ARIMA(0,0,4) for only Entero at PLOO", 
         ylab = "Entero (cfu/100mL)") +
  autolayer(arima_entero_ploo_q4_forecast, alpha=.3) +
  coord_cartesian(xlim=c(2015, 2025)) +
  coord_cartesian(ylim=c(0, 1000)) +
  theme_classic()
```


```{r, warning=FALSE}
print(paste("ARIMA(0,0,3) RMSE of ", arima_entero_ploo_q3_train_rmse))
print(paste("ARIMA(0,0,4) RMSE of ", arima_entero_ploo_q4_train_rmse))
  # the RMSE values are very close (they both round to 102.5) so going with simpler one (q=3)
```

### ARIMA of only entero on SBOO data
```{r, warning=FALSE}
# SBOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)
  # owt_df02_gb09_sboo_wkly02_train_tb03 
gb09_sboo_wkly02_train_ts01_ent01 <- ts(owt_df02_gb09_sboo_wkly02_train_tb03$ENTERO,
                                        start = c(1999, 3),
                                        freq = 52)
# SBOO Excluding Outliers - Test partition (01/11/2021-01/03/2022)
  # owt_df02_gb09_sboo_wkly02_test_tb03 

# pacf plot of entero (ploo)
par(mar=c(5, 4, 0, 2)+1.5)
pacf(gb09_sboo_wkly02_train_ts01_ent01)
title("Entero at SBOO pacf plot")

```

```{r, warning=FALSE}
# based on pacf plot with 1 set out of bounds, p=1
# no differencing done so d=0
# based on the acf plot with 2 or 3 sets out of bound, q=2 or 3
# seasonality in time series plot so need second set
  # P= seasonal AR= 0 since only out of bounds at beginning
  # D=0 (still no differencing)
  # Q= Seasonal MA (looking at year points on acf): repeated spikes corresponding to year ahead
    # therefore Q=1

# calling arima model for sboo
arima_entero_sboo_q2 <- arima(gb09_sboo_wkly02_train_ts01_ent01, 
                             order = c(1, 0, 2), 
                             seasonal = c(0, 0, 1))
summary(arima_entero_sboo_q2)

# saving training rmse value
arima_entero_sboo_q2_train_rmse <- sqrt(mean(arima_entero_sboo_q2$residuals^2))

# making forecasts and saving them
arima_entero_sboo_q2_forecast <- forecast(arima_entero_sboo_q2, h=52)

# getting plot ready
autoplot(gb09_sboo_wkly02_train_ts01_ent01, 
         main = "ARIMA(1,0,2)(0,0,1) for only Entero at SBOO", 
         ylab = "Entero (cfu/100mL)") +
  autolayer(arima_entero_sboo_q2_forecast, alpha=.3) +
  coord_cartesian(xlim=c(2015, 2025)) +
  theme_classic()
```

```{r, warning=FALSE}
# calling arima model for sboo with q=3
arima_entero_sboo_q3 <- arima(gb09_sboo_wkly02_train_ts01_ent01, 
                             order = c(1, 0, 3), 
                             seasonal = c(0, 0, 1))
summary(arima_entero_sboo_q3)

# saving training rmse value
arima_entero_sboo_q3_train_rmse <- sqrt(mean(arima_entero_sboo_q3$residuals^2))

# making forecasts and saving them
arima_entero_sboo_q3_forecast <- forecast(arima_entero_sboo_q3, h=52)

# getting plot ready
autoplot(gb09_sboo_wkly02_train_ts01_ent01, 
         main = "ARIMA(1,0,3)(0,0,1) for only Entero at SBOO", 
         ylab = "Entero (cfu/100mL)") +
  autolayer(arima_entero_sboo_q3_forecast, alpha=.3) +
  coord_cartesian(xlim=c(2015, 2025)) +
  theme_classic()
```

```{r}
print(paste("ARIMA(1,0,2)(0,0,1) RMSE of ", arima_entero_sboo_q2_train_rmse))
print(paste("ARIMA(1,0,3)(0,0,1) RMSE of ", arima_entero_sboo_q3_train_rmse))
  # q=2 RMSE of 303.3 vs. q=3 RMSE of 303.2; going with q=3 since lower.
```

## ARIMA Regression Models:

### ARIMA Regression 1-PLOO: Using all but SUSO and OG from PLOO
Use: chlorophyll, fecal, ph, salinity, temp, density, DO, XMS) to get: Entero
```{r}
# set up ARIMA regression
# PLOO Excluding Outliers - Training partition (01/18/1999-01/04/2021)

# training set: all predictors (minus the OG and SUSO) from PLOO
ploo_arima_train <- owt_df02_gb09_ploo_wkly02_train_tb03 %>% select(-date_sample)
# test set: all predictors (minus the OG and SUSO) from PLOO
ploo_arima_test <- owt_df02_gb09_ploo_wkly02_test_tb03 %>% select(-date_sample)

# predictors as matirx 
# predictors as matirx (1-9 columns)
ploo_arima_predictors_train_df <- ploo_arima_train %>% select(-ENTERO)
ploo_arima_predictors_train <- as.matrix(ploo_arima_predictors_train_df)

ploo_arima_predictors_test_df <- ploo_arima_test %>% select(-ENTERO)
ploo_arima_predictors_test <- as.matrix(ploo_arima_predictors_test_df)

# outcome
ploo_arima_train_outcome <- ploo_arima_train$ENTERO
ploo_arima_test_outcome <- ploo_arima_test$ENTERO

```

```{r}
# using the same model set up PLOO-entero only: ARIMA(0,0,3)
ploo_arimaReg <-Arima(ploo_arima_train_outcome, order = c(0,0,3), xreg = ploo_arima_predictors_train)

summary(ploo_arimaReg)

ploo_arimaReg_train_rmse <- sqrt(mean(ploo_arimaReg$residuals^2))
print(paste("PLOO ARIMA Regression RMSE: ", ploo_arimaReg_train_rmse))

# saving forecast using test set
ploo_arimaReg_forecast <- forecast(ploo_arimaReg, xreg= ploo_arima_predictors_test, h=52)
 
# plotting the forecasts
autoplot(ploo_arimaReg_forecast, 
         main = "PLOO ARIMA Regression (1,0,3)(0,0,1)", 
         ylab = "Entero (cfu/100mL)") +
  coord_cartesian(xlim = c(900, 1250))+
  theme_classic()

```

```{r}
ploo_arimaReg_coefs <- as.data.frame(round(ploo_arimaReg$coef, 3))
colnames(ploo_arimaReg_coefs)[colnames(ploo_arimaReg_coefs) == "round(ploo_arimaReg$coef, 3)"] <- "coef_value"
ploo_arimaReg_coefs
  # the three strongest absolute coeffecients (most important) at PLOO are:
    # pH (73), density (38), temp (7.43)
    # the next are DO (3.69), chlorophyll (2.35), XMS (.764), and fecal (.418)
```

### ARIMA Regression 1-SBOO: Using all but SUSO and OG from SBOO
Use: chlorophyll, fecal, ph, salinity, temp, density, DO, XMS) to get: Entero
```{r}
# set up ARIMA regression for SBOO

# training set: all predictors (minus the OG and SUSO) from SBOO
sboo_arima_train <- owt_df02_gb09_sboo_wkly02_train_tb03 %>% select(-date_sample)
# test set: all predictors (minus the OG and SUSO) from SBOO
sboo_arima_test <- owt_df02_gb09_sboo_wkly02_test_tb03 %>% select(-date_sample)

# predictors as matirx
sboo_arima_predictors_train_df <- sboo_arima_train %>% select(-ENTERO)
sboo_arima_predictors_train <- as.matrix(sboo_arima_predictors_train_df)

sboo_arima_predictors_test_df <- sboo_arima_test %>% select(-ENTERO)
sboo_arima_predictors_test <- as.matrix(sboo_arima_predictors_test_df)
# outcome
sboo_arima_train_outcome <- sboo_arima_train$ENTERO
sboo_arima_test_outcome <- sboo_arima_test$ENTERO
```

```{r}
# using the same model set up SBOO-entero only: ARIMA(1,0,3)(0,0,1)
sboo_arimaReg <-Arima(sboo_arima_train_outcome, order = c(1,0,3), seasonal = c(0,0,1), 
                      xreg = sboo_arima_predictors_train)
 
summary(sboo_arimaReg)

sboo_arimaReg_train_rmse <- sqrt(mean(sboo_arimaReg$residuals^2))
print(paste("SBOO ARIMA Regression RMSE: ", sboo_arimaReg_train_rmse))
# saving forecast using test set
sboo_arimaReg_forecast <- forecast(sboo_arimaReg, xreg= sboo_arima_predictors_test)
 
# plotting the forecasts
autoplot(sboo_arimaReg_forecast, 
         main = "SBOO ARIMA Regression (1,0,3)(0,0,1)", 
         ylab = "Entero (cfu/100mL)") +
  coord_cartesian(xlim = c(900, 1250))+
  theme_classic()
```

```{r}
sboo_arimaReg_coefs <- as.data.frame(round(sboo_arimaReg$coef, 3))
colnames(sboo_arimaReg_coefs)[colnames(sboo_arimaReg_coefs) == "round(sboo_arimaReg$coef, 3)"] <- "coef_value"
sboo_arimaReg_coefs
  # three strongest absolute coefficients (most important) at SBOO are:
    # pH (224), salinity (182), density (68), 
    # then it drops to DO (22), temp (17), xms (7.76), chlorophyll (4.60), fecal (.389)
```

## Comparing RMSE of ARIMA Models for PLOO and SBOO
```{r}
print("Looking at ARIMAs for PLOO Project:")
print(paste("PLOO ARIMA for only entero RMSE of ", round(arima_entero_ploo_q3_train_rmse, 0)))
print(paste("PLOO ARIMA Regression to get entero RMSE of ", round(ploo_arimaReg_train_rmse, 0)))      

print('_____________________________________________________________________________')
print("Looking at ARIMAs for SBOO Project:")
print(paste("SBOO ARIMA for only entero RMSE of ", round(arima_entero_sboo_q3_train_rmse, 0)))
print(paste("SBOO ARIMA Regression to get entero RMSE of ", round(sboo_arimaReg_train_rmse, 0)))

```

